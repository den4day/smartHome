<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="http://den4da12.beget.tech/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../reset.css">
    <link rel="stylesheet" href="style.css">
    <title>Smart Home</title>
</head>

<body>
    <div class="container">
        <header class="header">
            <nav class="header__nav">
                <img class="header__burger" src="../../img/burgerMenu.svg" alt="burger-menu">
                <a class="header__avatar" href="ac.html">
                    <img class="header__image" src="../../img/avatar.svg" alt="avatar">
                </a>
            </nav>
            <div class="header__greet">
                <div class="header__name">Hi Alexander</div>
                <div class="header__welcome">Welcome to your smart home</div>
            </div>
        </header>
        <article class="weather">
            <div class="weather__container">
                <img class="weather__img" src="../../img/cloudy.svg" alt="weather">
                <div class="weather__info">
                    <div class="weather__header">Cloudy</div>
                    <div class="weather__text">Tuesday, 13 April 2023</div>
                </div>
            </div>
            <button id="btn-toggle" disabled="disabled">Нагрузка...</button>
            <div>Нагрузка: <span id="field-l">---</span></div>
            <div class="weather__row">
                <div class="weather__block">
                    <div class="weather__article">Indor Temp</div>
                    <div class="weather__bg">
                        <div class="weather__data">
                            <span class="weather__indorTemp">---</span> °C
                        </div>
                    </div>
                </div>
                <div class="weather__block">
                    <div class="weather__article">Humidity</div>
                    <div class="weather__bg">
                        <div class="weather__data">
                            <span class="weather__hum">---</span> °C
                        </div>
                    </div>
                </div>
                <div class="weather__block">
                    <div class="weather__article">Outdor Temp</div>
                    <div class="weather__bg">
                        <div class="weather__data">
                            <span class="weather__outdorTemp">---</span> °C
                        </div>
                    </div>
                </div>
            </div>
        </article>
        <ul class="control__list">
            <li class="control__item control__item--active">Living Room</li>
            <li class="control__item">Bedroom</li>
            <li class="control__item">Dinning Room</li>
            <li class="control__item">Kitchen</li>
        </ul>
        <section class="control">
            <a class="control__tile" href="light.html">
                <div class="control__up">
                    <img class="control__image" src="../../img/lamp.svg" alt="lamp">
                    <label class="switch">
                        <input class="switch__input" type="checkbox">
                        <span class="switch__slider"></span>
                    </label>
                </div>
                <div class="control__info">
                    <div class="control__header">Light</div>
                    <div class="control__text">90%</div>
                </div>
            </a>
            <a class="control__tile" href="#">
                <div class="control__up">
                    <img class="control__image" src="../../img/snowflake.png" alt="AC">
                    <label class="switch">
                        <input class="switch__input" type="checkbox">
                        <span class="switch__slider"></span>
                    </label>
                </div>
                <div class="control__info">
                    <div class="control__header">AC</div>
                    <div class="control__text">25 °C</div>
                </div>
            </a>
            <a class="control__tile" href="#">
                <div class="control__up">
                    <img class="control__image" src="../../img/curtains.svg" alt="blinds">
                    <label class="switch">
                        <input class="switch__input" type="checkbox">
                        <span class="switch__slider"></span>
                    </label>
                </div>
                <div class="control__info">
                    <div class="control__header">Blinds</div>
                    <div class="control__text">30 °C</div>
                </div>
            </a>
            <a class="control__tile" href="#">
                <div class="control__up">
                    <img class="control__image" src="../../img/ventilation.svg" alt="venting">
                    <label class="switch">
                        <input class="switch__input" type="checkbox">
                        <span class="switch__slider"></span>
                    </label>
                </div>
                <div class="control__info">
                    <div class="control__header">Venting</div>
                    <div class="control__text">50 °C</div>
                </div>
            </a>
            <a class="control__tile" href="#">
                <div class="control__up">
                    <img class="control__image" src="../../img/cv.svg" alt="CV">
                    <label class="switch">
                        <input class="switch__input" type="checkbox">
                        <span class="switch__slider"></span>
                    </label>
                </div>
                <div class="control__info">
                    <div class="control__header">CV</div>
                    <div class="control__text">45 °C</div>
                </div>
            </a>
            <a class="control__tile" href="#">
                <div class="control__up">
                    <img class="control__image" src="../../img/robot.svg" alt="robot">
                    <label class="switch">
                        <input class="switch__input" type="checkbox">
                        <span class="switch__slider"></span>
                    </label>
                </div>
                <div class="control__info">
                    <div class="control__header">Robot</div>
                    <div class="control__text">80 °C</div>
                </div>
            </a>
        </section>
        <footer class="footer">
            <button class="footer__btn">Turn off all devices</button>
        </footer>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <!-- <script src="script.js"></script> -->
    <script>
        let sock = io();

        let net = require('net');
        let app = require('express')();
        let http = require('http').createServer(app);
        let io = require('socket.io')(http);

        // фейковое хранилище всех подключенных ESP
        // в реальной жизни вам понадобится различать их
        // вы можете при подключении передавать информацию, например уникальный номер
        let esps = [];

        // буфер входящих данных
        let packet = '';

        // создаем TCP сервер для приема соединений от наших ESP
        let server = net.createServer(sock => {
            console.log('ESP connected');
            // кладем в наше хранилище новый коннект
            esps.push(sock);

            // подписываем на событие прихода данных по сокету
            sock.on('data', data => {
                // складываем в буфер
                // в реальной жизни нужно учитывать если платок больше 1ой
                // на каждую нужен отдельный буфер
                packet += data;
                // ищем символы переноса строки
                const idx = packet.indexOf('\r\n');
                // если найдены то мы получили полный пакет
                if (idx != -1) {
                    // берем из буфера часть, которая содержит 1 целый пакет
                    // и вызываем обработчик для этого пакета
                    handler(packet.substr(0, idx));
                    // удаляем обработанный пакет из буфера
                    packet = packet.substr(idx + 2);
                }
            })

            // в реальной жизни, в случае ошибки на сокете,
            // обрабатываем ее, например отключаем сокет и удаляем из хранилища
            sock.on('error', err => {
                console.log(err);
            });

            // если сокет отключился удаляем его из нашего хранилища
            sock.on('end', () => {
                console.log('ESP disconnected');
                const pos = esps.indexOf(sock);
                if (pos != -1) {
                    esps.splice(pos, 1);
                }
            });
        });

        // указываем какой порт и ip адрес нужно начать слушать нашему TCP серверу
        server.listen(3030, '192.168.115.159');

        // вспомогательная функция для отправки пакета
        function send_packet(data) {
            // если есть подключенные esp
            if (esps.length) {
                //перебираем их и шлем по очереди наш пакет
                for (const esp of esps) {
                    try {
                        esp.write(data + '\n');
                    } catch (err) {
                        console.log(err);
                    }
                }
            } else {
                console.log('Error: ESP not found');
            }
        }

        // вспомогательная функция для обработки пакетов
        function handler(packet) {
            console.log('Packet:', packet);
            // формат пакета описан в статье
            // разбиваем на части
            const parts = packet.split('&');
            // смотрим что за пакет
            switch (parts[0]) {
                case 'status':
                    // удалим часть которая нам больше не нужна
                    parts.splice(0, 1);
                    // вспомогательный объект для отправки в web сокет
                    const res = {};
                    // перебираем все части и складываем в один объект
                    // мы могли формировать сразу в esp8266 готовый json
                    // или могли бы парсить данные на клиенте
                    for (const el of parts) {
                        // разбиваем на ключ - значение
                        const tmp = el.split(':');
                        // пишем в объект
                        res[tmp[0]] = tmp[1];
                    }
                    // и отсылаем в web сокет
                    io.emit('status', res);
                    break;
                default:
                    console.log('Error: unknown handler')
            }
        }

        // эту часть я поручаю nginx
        // но для краткости и удобства для статьи я решил обойтись средствами node.js
        app.get('/', (req, res) => {
            // отдаем статик файл в браузер
            res.sendFile(__dirname + '/view/pages/home/index.html');
        });

        // событие при подключении нового web socket
        io.on('connection', sock => {
            // если пришла команда status
            sock.on('status', () => {
                // просто отправляем ее на наш wifi модуль
                send_packet('status');
            }).on('toggle', data => {
                // для команды toggle меняем название команды
                // и добавляем параметр в том формате в котором его ожидает наш esp-01 модуль
                send_packet('load&' + (data ? 'on' : 'off'));
            });
        });

        // запускаем наш web сервер
        http.listen(3000, () => {
            console.log('listening on *:3000');
        });
    </script>
</body>

</html>